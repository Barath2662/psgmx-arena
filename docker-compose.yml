version: '3.8'

# PSGMX Arena - Docker Compose (Supabase mode)
# Database and Auth are handled by Supabase (remote).
# For local dev, just run: dev.bat  (or npm run dev + npm run socket:dev)

services:
  # ─── Piston Code Execution Engine ───────────────────────
  # Self-hosted sandboxed code runner (FREE, unlimited, open-source)
  # Supports C, C++, Java, Python, JavaScript, TypeScript, Go, Rust, Ruby, PHP
  # Handles 120+ concurrent executions with the resource limits below
  piston:
    image: ghcr.io/engineer-man/piston:latest
    restart: unless-stopped
    ports:
      - '2000:2000'
    tmpfs:
      - /piston/jobs:exec,size=512M
    privileged: true
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G
    environment:
      - PISTON_RUN_TIMEOUT=10000
      - PISTON_COMPILE_TIMEOUT=10000
      - PISTON_OUTPUT_MAX_SIZE=65536
      - PISTON_MAX_PROCESS_COUNT=128
      - PISTON_MAX_OPEN_FILES=2048

  # Next.js App (Client)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - '3000:3000'
    env_file:
      - .env
    depends_on: []

  # Socket.IO Server
  socket:
    build:
      context: .
      dockerfile: Dockerfile.socket
    restart: unless-stopped
    ports:
      - '3001:3001'
    env_file:
      - .env
    environment:
      WS_PORT: 3001
    depends_on: []
